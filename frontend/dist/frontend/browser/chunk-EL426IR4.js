import{F as h,J as u,M as p,Sb as f,Tb as E,f as b,j as d,w as i}from"./chunk-3KMOHGR5.js";var l=class extends Error{};l.prototype.name="InvalidTokenError";function v(s){return decodeURIComponent(atob(s).replace(/(.)/g,(e,t)=>{let r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}function m(s){let e=s.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return v(e)}catch{return atob(e)}}function c(s,e){if(typeof s!="string")throw new l("Invalid token specified: must be a string");e||(e={});let t=e.header===!0?0:1,r=s.split(".")[t];if(typeof r!="string")throw new l(`Invalid token specified: missing part #${t+1}`);let n;try{n=m(r)}catch(o){throw new l(`Invalid token specified: invalid base64 for part #${t+1} (${o.message})`)}try{return JSON.parse(n)}catch(o){throw new l(`Invalid token specified: invalid json for part #${t+1} (${o.message})`)}}var a={AUTH:{SIGNIN:"/api/auth/signin",SIGNUP:"/api/auth/signup",FORGOT_PASSWORD:"/api/auth/forgot-password",RESET_PASSWORD:"/api/auth/reset-password",REFRESH_TOKEN:"/api/auth/refresh-token"},USERS:{BASE:"/api/users",BY_ID:s=>`/api/users/${s}`},EVENTS:{BASE:"/api/events",BY_ID:s=>`/api/events/${s}`},CONTRACTS:{BASE:"/api/contracts",BY_ID:s=>`/api/contracts/${s}`,REPORT:s=>`/api/contracts/${s}/report`},RESOURCES:{BASE:"/api/resources",SEARCH:"/api/resources/search",BY_ID:s=>`/api/resources/${s}`},PROVIDERS:{BASE:"/api/providers",BY_ID:s=>`/api/providers/${s}`},PERSONNEL:{BASE:"/api/personnel",BY_ID:s=>`/api/personnel/${s}`},TYPES:{EVENT:{BASE:"/api/event-types",BY_ID:s=>`/api/event-types/${s}`},PROVIDER:{BASE:"/api/provider-types",BY_ID:s=>`/api/provider-types/${s}`},PERSONNEL:{BASE:"/api/personnel-types",BY_ID:s=>`/api/personnel-types/${s}`},RESOURCE:{BASE:"/api/resource-types",BY_ID:s=>`/api/resource-types/${s}`}}};var I={API_URL:"http://54.156.38.225:3000"};var g=class s{constructor(e){this.http=e}urlBase=I.API_URL;getHeaders(){let e=localStorage.getItem("token"),t={"Content-Type":"application/json"};return e&&(t.Authorization=`Bearer ${e}`),new f(t)}getPr(e){return new Promise((t,r)=>{this.http.get(this.urlBase+e,{headers:this.getHeaders()}).subscribe({next:n=>t(n),error:n=>r(n)})})}getOb(e){return this.http.get(this.urlBase+e,{headers:this.getHeaders()})}postPr(e,t){return new Promise((r,n)=>{this.http.post(this.urlBase+e,t,{headers:this.getHeaders()}).subscribe({next:o=>r(o),error:o=>n(o)})})}postOb(e,t){return this.http.post(this.urlBase+e,t,{headers:this.getHeaders()})}putPr(e,t){return new Promise((r,n)=>{this.http.put(this.urlBase+e,t,{headers:this.getHeaders()}).subscribe({next:o=>r(o),error:o=>n(o)})})}putOb(e,t){return this.http.put(this.urlBase+e,t,{headers:this.getHeaders()})}deletePr(e){return new Promise((t,r)=>{this.http.delete(this.urlBase+e,{headers:this.getHeaders()}).subscribe({next:n=>t(n),error:n=>r(n)})})}deleteOb(e){return this.http.delete(this.urlBase+e,{headers:this.getHeaders()})}patchPr(e,t){return new Promise((r,n)=>{this.http.patch(this.urlBase+e,t,{headers:this.getHeaders()}).subscribe({next:o=>r(o),error:o=>n(o)})})}patchOb(e,t){return this.http.patch(this.urlBase+e,t,{headers:this.getHeaders()})}static \u0275fac=function(t){return new(t||s)(p(E))};static \u0275prov=u({token:s,factory:s.\u0275fac,providedIn:"root"})};var S=class s{constructor(e){this.apiService=e}TOKEN_KEY="token";authState=new b(this.hasValidToken());register(e){return["admin","coordinador","lider"].includes(e.role)?this.apiService.postOb(a.AUTH.SIGNUP,e).pipe(h(r=>this.handleAuthSuccess(r)),i(r=>this.handleError("Error al registrar",r))):d(()=>new Error("Rol no v\xE1lido"))}login(e,t){return this.apiService.postOb(a.AUTH.SIGNIN,{email:e,password:t}).pipe(h(r=>{if(r.user&&!r.user.active)throw new Error("Tu cuenta est\xE1 desactivada. Contacta al administrador.");this.handleAuthSuccess(r)}),i(r=>this.handleError("Error al iniciar sesi\xF3n",r)))}handleAuthSuccess(e){if(e?.token)try{c(e.token),localStorage.setItem(this.TOKEN_KEY,e.token),this.authState.next(!0)}catch{this.authState.next(!1)}else this.authState.next(!1)}get authStatus$(){return this.authState.asObservable()}isLoggedIn(){let e=this.getToken();if(!e)return!1;try{let t=c(e);return Date.now()<t.exp*1e3}catch{return!1}}logout(){localStorage.removeItem(this.TOKEN_KEY),this.authState.next(!1)}getToken(){return localStorage.getItem(this.TOKEN_KEY)}hasValidToken(){let e=this.getToken();if(!e)return!1;try{let t=c(e);return Date.now()<t.exp*1e3}catch{return!1}}isTokenExpired(){let e=this.getToken();if(!e)return!0;try{let t=c(e);return Date.now()>=t.exp*1e3}catch{return!0}}decodeToken(e){let t=e||this.getToken();if(!t)return null;try{return c(t)}catch{return null}}getUserRole(){return this.decodeToken()?.role||null}getUserId(){return this.decodeToken()?.id||null}getCurrentUserData(){let e=this.decodeToken();return e?{id:e.id,email:e.email,role:e.role}:null}hasRole(e){return this.getUserRole()===e}hasAnyRole(e){let t=this.getUserRole();return t?e.includes(t):!1}shouldRefreshToken(e=5){let t=this.getToken();if(!t)return!1;try{let r=c(t),n=Date.now()/1e3,o=r.exp-e*60;return n>=o}catch{return!1}}refreshToken(){return this.apiService.postOb(a.AUTH.REFRESH_TOKEN,{}).pipe(h(e=>this.handleAuthSuccess(e)),i(e=>this.handleError("Error al refrescar token",e)))}getUserProfile(){let e=this.getUserId();return e?this.apiService.getOb(a.USERS.BY_ID(e)).pipe(i(t=>this.handleError("Error obteniendo perfil",t))):d(()=>new Error("No se pudo obtener el ID del usuario"))}updateUserProfile(e){let t=this.getUserId();return t?this.apiService.putOb(a.USERS.BY_ID(t),e).pipe(i(r=>this.handleError("Error actualizando perfil",r))):d(()=>new Error("No se pudo obtener el ID del usuario"))}forgotPassword(e){return this.apiService.postOb(a.AUTH.FORGOT_PASSWORD,{email:e}).pipe(i(t=>this.handlePasswordError(t,"recuperaci\xF3n")))}resetPassword(e,t){return this.apiService.postOb(a.AUTH.RESET_PASSWORD,{token:e,newPassword:t}).pipe(i(r=>this.handlePasswordError(r,"actualizaci\xF3n")))}handlePasswordError(e,t){let r=`Error en la ${t}`;return e.error?.message?r=e.error.message:e.status===404?r="Usuario no encontrado":e.status===400&&(r="Token inv\xE1lido o expirado"),d(()=>new Error(r))}handleError(e,t){return this.authState.next(!1),d(()=>t?.error?.message||`${e}. Intenta nuevamente.`)}static \u0275fac=function(t){return new(t||s)(p(g))};static \u0275prov=u({token:s,factory:s.\u0275fac,providedIn:"root"})};export{c as a,a as b,I as c,g as d,S as e};
